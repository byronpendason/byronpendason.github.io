<div id="calendar">
  <div id="debug"></div>
  <h2 id="current-calendar"></h2>
  <h5 id="leap"></h5>
   <form style="width:100%">
    <label>Enter year:</label>
    <input type="text" id="yrInput" style="width:5em" placeholder="CE only">
    <button type="button" id="submit" value="Get Calendar">Get Calendar</button>
  </form>
  <h3>Months</h3>

  <table id="months-table" style="width:100%">
  </table>
  
  <h3>High Holidays</h3>
  <p>These are the holidays that almost every Heathen observes (though usually by a different name and possibly at other times).</p>
  <table id="holidays-table" style="width:100%">
    <tr>
      <th>Holiday</th>
      <th>Date</th>
      <th>Anglo-Saxon Date</th>
    </tr>
  </table>
  <h3>Other Holidays</h3>
  <p>These holidays are far from universal, but are observed by at least some Heathens who use the pre-Christian Anglo-Saxons as a primary source for their spirituality. Most of these are taken from the Ingvaeonic Society's <a href="https://ingwine.org/knowledge-base-2/the-holy-calendar/">The Holy Calendar</a>, unless another source is listed in parenthesis.</p>
  <table id="other-holidays-table" style="width:100%">
    <tr>
      <th>Holiday</th>
      <th>Date</th>
      <th>Anglo-Saxon Date</th>
    </tr>
  </table>
  <p id="today"></p>
  <h3>Date Converter</h3>
  <p>Enter a Date below, and it will be converted to the Anglo-Saxon Date. If the Date is outside the currently selected year, this page will refresh with the calendar for that year.</p>
  <form>
      <label for="chosenDate">Choose a Date:</label>
      <input type="Date" id="chosenDate" name="chosenDate">
  </form>
  <p id="conv"></p>
</div>

<script type="text/python">
  from browser import document, html
  from datetime import datetime, timedelta
  
  def makeCalendar(yr):
    temp = years[yr-1700].split("_")
    if temp[5] == "true":
      leap = True
    else:
      leap = False
    y = Year(temp[0], temp[1], temp[2], leap)
    nm = temp[3].split("=")
    fm = temp[4].split("=")
    for i in range(len(nm)):
      if nm[i] != "":
        y.addNewMoon(nm[i])
      if fm[i] != "":
        y.addFullMoon(fm[i])
    return y
  
  def showCalendar(year):
    monthNames = ["Æfterra Ġēola", "Solmōnaþ", "Hreðmōnaþ", "Ēosturmōnaþ", "Þrimilcemōnaþ", "Ærra Liða", "Þriliða", "Æfterra Liða", "Weodmōnaþ", "Hāliġmōnaþ", "Wintermōnaþ", "Blōtmōnaþ", "Ærra Ġēola"]
    if year.leap == False:
      monthNames.pop(6)
    row = html.TR()
    row <= html.TH("Month")+html.TH("Starts")+html.TH("Full Moon")
    document["months-table"] <= row
    for i in range(len(monthNames)):
      name = monthNames[i]
      nm = year.newMoons[i].strftime("%a, %b %d, %Y CE")
      fm = year.fullMoons[i].strftime("%a, %b %d, %Y CE")
      document["months-table"] <= html.TR(html.TD(name)+html.TD(nm)+html.TD(fm))

  def debug(msg):
   document["debug"] <= html.P("DEBUG: "+msg)
  
  def getASDate(d):
    #date = datetime(d.year, d.month, d.day)
    x = int(d.strftime("%Y"))
    yr = makeCalendar(x)
    debug("Calendar made!")
    m = 0
    while d > yr.newMoons[m]:
      if i-1 == len(yr.newMoons):
        break
      m += 1
    m -= 1
    delta = d - yr.newMoons[m]
    day = int(delta.days) + 1
    debug(str(day))
    
  class Year:
    def __init__(self, year, midsummer, yule, leap):
      date_string = '%Y/%m/%d %H:%M:%S'
      self.yr = year
      self.midsummer = datetime.strptime(midsummer, date_string)
      self.yule = datetime.strptime(yule, date_string)
      self.newMoons = []
      self.fullMoons = []
      self.leap = leap
    def addNewMoon(self, d):
      date_string = '%Y-%m-%dT%H:%M:%S'
      temp = datetime.strptime(d, date_string)
      self.newMoons.append(temp)
    def addFullMoon(self, d):
      date_string = '%Y-%m-%dT%H:%M:%S'
      temp = datetime.strptime(d, date_string)
      self.fullMoons.append(temp)
      
  
  years = []
  {% for yr in site.data.calendar %}
  years.append("{{ yr.year }}_{{ yr.midsummer }}_{{ yr.yule }}_{% for nm in yr.new_moons %}{{ nm }}={% endfor %}_{% for fm in yr.full_moons %}{{ fm }}={% endfor %}_{{ yr.leap }}")
  {% endfor %}
  date = datetime.now()
  getASDate(date)
  x = int(date.strftime("%Y"))
  
  year = makeCalendar(x)
  showCalendar(year)
  document["current-calendar"].text = "Anglo-Saxon Calendar for " + year.yr
 
</script>